<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionStorage and Google Drive</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <h1>SessionStorage and Google Drive Example</h1>
<button onclick="saveArrayToSession()">Save Array in SessionStorage</button>
<button onclick="retrieveArrayFromSession()">Retrieve Array from SessionStorage</button>
<button onclick="authorize()">Authorize</button>
<button onclick="saveToGoogleDrive()">Save on Google Drive</button>
<button onclick="getFromGoogleDrive()">Get from Google Drive</button>
    <p id="output"></p>

<script>
    const CLIENT_ID = '371617464258-ntrqn44lfo1lpi294hmc5ebad5b9ok5a.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbf0IPLaP6Cbbx3NnFlfzcWQ-zxIc5S8E';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;

    function saveArrayToSession() {
        const array = Array.from({ length: 10 }, () => Math.floor(Math.random() * 100));
        sessionStorage.setItem('randomArray', JSON.stringify(array));
        alert('Array saved in SessionStorage.');
    }

    function retrieveArrayFromSession() {
        const array = JSON.parse(sessionStorage.getItem('randomArray'));
        document.getElementById('output').innerText = 'SessionStorage Array: ' + array;
    }

    function initializeGoogleIdentity() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    sessionStorage.setItem('accessToken', tokenResponse.access_token);
                    alert('Authorization successful.');
                }
            },
        });
    }

    function authorize() {
        tokenClient.requestAccessToken();
    }

function deleteFile(fileId, accessToken) {
    return fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
        method: 'DELETE',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
    });
}

function saveToGoogleDrive() {
    const accessToken = sessionStorage.getItem('accessToken');
    if (!accessToken) {
        alert('You need to authorize first.');
        return;
    }

    const existingFileId = sessionStorage.getItem('fileId');

    const saveNewFile = () => {
        const array = sessionStorage.getItem('randomArray');
        const fileContent = array;
        const file = new Blob([fileContent], { type: 'text/plain' });
        const metadata = {
            'name': 'randomArray.txt',
            'mimeType': 'text/plain'
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form
        }).then((res) => res.json()).then((val) => {
            console.log(val);
            if (val.error) {
                throw new Error(val.error.message);
            }
            sessionStorage.setItem('fileId', val.id);
            alert('File saved to Google Drive with ID: ' + val.id);
        }).catch((error) => {
            alert('Error saving file: ' + error.message);
        });
    };

    if (existingFileId) {
        deleteFile(existingFileId, accessToken)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete existing file');
                }
                console.log('Previous file deleted successfully');
                saveNewFile();
            })
            .catch(error => {
                console.error('Error deleting file:', error);
                // If deletion fails, we still proceed to save the new file
                saveNewFile();
            });
    } else {
        saveNewFile();
    }
}

    function getFromGoogleDrive() {
        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            alert('You need to authorize first.');
            return;
        }

        const fileId = sessionStorage.getItem('fileId');
        if (!fileId) {
            alert('No file ID found. Save a file to Google Drive first.');
            return;
        }

        fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            method: 'GET',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
        }).then(response => response.text()).then((data) => {
            localStorage.setItem('retrievedArray', data);
            document.getElementById('output').innerText = 'Retrieved from Drive: ' + data;
        }).catch((error) => {
            alert('Error retrieving file: ' + error.message);
        });
    }

    window.onload = initializeGoogleIdentity;
</script>
</body>
</html>
