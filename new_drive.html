<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionStorage and Google Drive</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.paypalobjects.com/donate/sdk/donate-sdk.js" charset="UTF-8"></script>
</head>
<body>
    <h1>SessionStorage and Google Drive Example</h1>
<button onclick="saveArrayToSession()">Save Array in SessionStorage</button>
<button onclick="retrieveArrayFromSession()">Retrieve Array from SessionStorage</button>
<button onclick="authorize()">Authorize</button>
<button onclick="saveToGoogleDrive()">Save on Google Drive</button>
<button onclick="getFromGoogleDrive()">Get from Google Drive</button>
    <p id="output"></p>

<form id="ppDonate" action="https://www.sandbox.paypal.com/donate" method="post" target="_top">
<input type="hidden" name="hosted_button_id" value="9U3RDMXSDKD6N" />
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.sandbox.paypal.com/en_GR/i/scr/pixel.gif" width="1" height="1" />
</form>


<script>
    const CLIENT_ID = '371617464258-ntrqn44lfo1lpi294hmc5ebad5b9ok5a.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbf0IPLaP6Cbbx3NnFlfzcWQ-zxIc5S8E';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;

    function saveArrayToSession() {
        const array = Array.from({ length: 10 }, () => Math.floor(Math.random() * 100));
        sessionStorage.setItem('randomArray', JSON.stringify(array));
        alert('Array saved in SessionStorage.');
    }

    function retrieveArrayFromSession() {
        const array = JSON.parse(sessionStorage.getItem('randomArray'));
        document.getElementById('output').innerText = 'SessionStorage Array: ' + array;
    }

    function initializeGoogleIdentity() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    sessionStorage.setItem('accessToken', tokenResponse.access_token);
                    alert('Authorization successful.');
                }
            },
        });
    }

    function authorize() {
        tokenClient.requestAccessToken();
    }

function searchAndDeleteFiles(accessToken) {
    return fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27randomArray.txt%27', {
        method: 'GET',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
    })
    .then(response => response.json())
    .then(data => {
        if (data.files && data.files.length > 0) {
            const deletePromises = data.files.map(file => 
                fetch(`https://www.googleapis.com/drive/v3/files/${file.id}`, {
                    method: 'DELETE',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
                })
            );
            return Promise.all(deletePromises);
        }
    });
}

function saveToGoogleDrive() {
    const accessToken = sessionStorage.getItem('accessToken');
    if (!accessToken) {
        alert('You need to authorize first.');
        return;
    }

    const saveNewFile = () => {
        const array = sessionStorage.getItem('randomArray');
        const fileContent = array;
        const file = new Blob([fileContent], { type: 'text/plain' });
        const metadata = {
            'name': 'randomArray.txt',
            'mimeType': 'text/plain'
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form
        }).then((res) => res.json()).then((val) => {
            console.log(val);
            if (val.error) {
                throw new Error(val.error.message);
            }
            sessionStorage.setItem('fileId', val.id);
            alert('File saved to Google Drive with ID: ' + val.id);
            // open PayPal donate form
            document.getElementById('ppDonate').submit();
        }).catch((error) => {
            alert('Error saving file: ' + error.message);
        });
    };

    searchAndDeleteFiles(accessToken)
        .then(() => {
            console.log('Previous files deleted successfully');
            saveNewFile();
        })
        .catch(error => {
            console.error('Error searching or deleting files:', error);
            // If search or deletion fails, we still proceed to save the new file
            saveNewFile();
        });
}

    function getFromGoogleDrive() {
        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            alert('You need to authorize first.');
            return;
        }

        const fileId = sessionStorage.getItem('fileId');
        if (!fileId) {
            alert('No file ID found. Save a file to Google Drive first.');
            return;
        }

        fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            method: 'GET',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
        }).then(response => response.text()).then((data) => {
            localStorage.setItem('retrievedArray', data);
            document.getElementById('output').innerText = 'Retrieved from Drive: ' + data;
        }).catch((error) => {
            alert('Error retrieving file: ' + error.message);
        });
    }

    window.onload = initializeGoogleIdentity;
</script>
</body>
</html>
