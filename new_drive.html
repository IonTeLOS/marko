<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionStorage and Google Drive</title>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <h1>SessionStorage and Google Drive Example</h1>
    <button onclick="saveArrayToSession()">Save Array in SessionStorage</button>
    <button onclick="retrieveArrayFromSession()">Retrieve Array from SessionStorage</button>
    <button onclick="authorize()">Authorize</button>
    <button onclick="saveToGoogleDrive()">Save on Google Drive</button>
    <button onclick="getFromGoogleDrive()">Get from Google Drive</button>
    <p id="output"></p>

    <script>
        const CLIENT_ID = '371617464258-ntrqn44lfo1lpi294hmc5ebad5b9ok5a.apps.googleusercontent.com'; // Replace with your actual Client ID
        const API_KEY = 'AIzaSyAbf0IPLaP6Cbbx3NnFlfzcWQ-zxIc5S8E'; // Replace with your actual API Key
        const REDIRECT_URI = 'http://teloslinux.org/marko/new_drive';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        function saveArrayToSession() {
            const array = Array.from({ length: 10 }, () => Math.floor(Math.random() * 100));
            sessionStorage.setItem('randomArray', JSON.stringify(array));
            alert('Array saved in SessionStorage.');
        }

        function retrieveArrayFromSession() {
            const array = JSON.parse(sessionStorage.getItem('randomArray'));
            document.getElementById('output').innerText = 'SessionStorage Array: ' + array;
        }

        function authorize() {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${SCOPES}`;
            window.location.href = authUrl;
        }

        function handleAuthResponse() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        code: code,
                        client_id: CLIENT_ID,
                        client_secret: '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', // Replace with your actual Client Secret
                        redirect_uri: REDIRECT_URI,
                        grant_type: 'authorization_code'
                    })
                }).then(response => response.json())
                  .then(data => {
                      if (data.error) {
                          throw new Error(data.error);
                      }
                      sessionStorage.setItem('accessToken', data.access_token);
                      window.history.pushState({}, document.title, window.location.pathname);
                      alert('Authorization successful.');
                  }).catch(error => {
                      alert('Error exchanging authorization code for token: ' + error.message);
                  });
            }
        }

        function saveToGoogleDrive() {
            const accessToken = sessionStorage.getItem('accessToken');
            if (!accessToken) {
                alert('You need to authorize first.');
                return;
            }

            const array = sessionStorage.getItem('randomArray');
            const fileContent = array;
            const file = new Blob([fileContent], { type: 'text/plain' });
            const metadata = {
                'name': 'randomArray.txt',
                'mimeType': 'text/plain'
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            }).then((res) => res.json()).then((val) => {
                console.log(val);
                if (val.error) {
                    throw new Error(val.error.message);
                }
                sessionStorage.setItem('fileId', val.id);
                alert('File saved to Google Drive with ID: ' + val.id);
            }).catch((error) => {
                alert('Error saving file: ' + error.message);
            });
        }

        function getFromGoogleDrive() {
            const accessToken = sessionStorage.getItem('accessToken');
            if (!accessToken) {
                alert('You need to authorize first.');
                return;
            }

            const fileId = sessionStorage.getItem('fileId');
            if (!fileId) {
                alert('No file ID found. Save a file to Google Drive first.');
                return;
            }

            fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                method: 'GET',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
            }).then(response => response.text()).then((data) => {
                localStorage.setItem('retrievedArray', data);
                document.getElementById('output').innerText = 'Retrieved from Drive: ' + data;
            }).catch((error) => {
                alert('Error retrieving file: ' + error.message);
            });
        }

        function loadClient() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                scope: SCOPES
            }).then(() => {
                gapi.auth2.getAuthInstance();
            }).catch((error) => {
                console.error('Error initializing Google API client:', error);
                alert('Error initializing Google API client: ' + JSON.stringify(error));
            });
        }

        window.onload = () => {
            loadClient();
            handleAuthResponse();
        };
    </script>
</body>
</html>
