<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionStorage and Google Drive</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.paypalobjects.com/donate/sdk/donate-sdk.js" charset="UTF-8"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
.google-button {
    display: inline-flex;
    align-items: center;
    background-color: #4285f4;
    color: white;
    border: none;
    border-radius: 3px;
    font-family: 'Roboto', sans-serif;
    font-size: 14px;
    font-weight: 500;
    padding: 10px 20px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.google-button:hover {
    background-color: #3367d6;
}

.google-button .material-icons {
    margin-right: 10px;
}
</style>
</head>
<body>
    <h1>SessionStorage and Google Drive Example</h1>
<button onclick="saveArrayToSession()">Save Array in SessionStorage</button>
<button onclick="retrieveArrayFromSession()">Retrieve Array from SessionStorage</button>
<button id="syncToDrive" class="google-button" onclick="saveToGoogleDrive()">
    <span class="material-icons">cloud_upload</span>
    Sync TO Drive
</button>
<button id="syncFromDrive" class="google-button" onclick="getFromGoogleDrive()">
    <span class="material-icons">cloud_download</span>
    Sync FROM Drive
</button>
    <p id="output"></p>

<form id="ppDonate" action="https://www.sandbox.paypal.com/donate" method="post" target="_top">
<input type="hidden" name="hosted_button_id" value="9U3RDMXSDKD6N" />
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.sandbox.paypal.com/en_GR/i/scr/pixel.gif" width="1" height="1" />
</form>


<script>
    const CLIENT_ID = '371617464258-ntrqn44lfo1lpi294hmc5ebad5b9ok5a.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAbf0IPLaP6Cbbx3NnFlfzcWQ-zxIc5S8E';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;

    function saveArrayToSession() {
        const array = Array.from({ length: 10 }, () => Math.floor(Math.random() * 100));
        sessionStorage.setItem('randomArray', JSON.stringify(array));
        alert('Array saved in SessionStorage.');
    }

    function retrieveArrayFromSession() {
        const array = JSON.parse(sessionStorage.getItem('randomArray'));
        document.getElementById('output').innerText = 'SessionStorage Array: ' + array;
    }

    function initializeGoogleIdentity() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    sessionStorage.setItem('accessToken', tokenResponse.access_token);
                    alert('Authorization successful.');
                }
            },
        });
    }

function authorize() {
    return new Promise((resolve, reject) => {
        tokenClient.callback = (resp) => {
            if (resp.error !== undefined) {
                reject(resp);
            } else {
                sessionStorage.setItem('accessToken', resp.access_token);
                resolve(resp);
            }
        };
        if (sessionStorage.getItem('accessToken')) {
            resolve({access_token: sessionStorage.getItem('accessToken')});
        } else {
            tokenClient.requestAccessToken({prompt: 'consent'});
        }
    });
}

function searchAndDeleteFiles(accessToken) {
    return fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27bookmarksMarko.txt%27', {
        method: 'GET',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
    })
    .then(response => response.json())
    .then(data => {
        if (data.files && data.files.length > 0) {
            const deletePromises = data.files.map(file => 
                fetch(`https://www.googleapis.com/drive/v3/files/${file.id}`, {
                    method: 'DELETE',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
                })
            );
            return Promise.all(deletePromises);
        }
    });
}

function saveToGoogleDrive() {
    document.getElementById('syncToDrive').disabled = true;
    const confirmUpload = confirm("Are you sure you want to save your bookmarks to Google Drive?");

    // If user cancels, exit the function
    if (!confirmUpload) {
        document.getElementById('syncToDrive').disabled = false;
        return;
    }
    const ensureAuthorization = () => {
        if (!sessionStorage.getItem('accessToken')) {
            alert('You need to authorize first. Initiating authorization...');
            return authorize();
        } else {
            return Promise.resolve({access_token: sessionStorage.getItem('accessToken')});
        }
    };

    const saveNewFile = () => {
        return new Promise((resolve, reject) => {
            const accessToken = sessionStorage.getItem('accessToken');
            if (!accessToken) {
                reject(new Error('No access token available. Please authorize first.'));
                return;
            }
            const array = sessionStorage.getItem('randomArray');
            const fileContent = array;
            const file = new Blob([fileContent], { type: 'text/plain' });
            const metadata = {
                'name': 'bookmarksMarko.txt',
                'mimeType': 'text/plain'
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            })
            .then((res) => res.json())
            .then((val) => {
                console.log(val);
                if (val.error) {
                    throw new Error(val.error.message);
                }
                sessionStorage.setItem('fileId', val.id);
                alert('File saved to Google Drive as bookmarksMarko.txt with ID: ' + val.id);
                resolve(val);
                document.getElementById('syncToDrive').disabled = false;
            })
            .catch((error) => {
                document.getElementById('syncToDrive').disabled = false;
                reject(error);
            });
        });
    };

    ensureAuthorization()
        .then(() => searchAndDeleteFiles(sessionStorage.getItem('accessToken')))
        .then(() => {
            console.log('Previous files deleted successfully');
            return saveNewFile();
        })
        .then(() => {
            console.log('New file saved successfully');
            // Simulate click on PayPal donate form only after successful save
            const paypalForm = document.getElementById('ppDonate');
            if (paypalForm) {
                paypalForm.submit();
            } else {
                console.warn('PayPal donate form not found');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message.includes('Authorization required')) {
                alert('Authorization failed. Please try again.');
            } else {
                alert('An error occurred: ' + error.message);
            }
        });
}
    
function getFromGoogleDrive() {
    document.getElementById('syncFromDrive').disabled = true;
    const confirmDownload = confirm("Are you sure you want to sync your bookmarks from Google Drive? This will overwrite any existing local Marko bookmarks.");

    // If user cancels, exit the function
    if (!confirmDownload) {
        document.getElementById('syncFromDrive').disabled = false;
        return;
    }
    const ensureAuthorization = () => {
        if (!sessionStorage.getItem('accessToken')) {
            alert('You need to authorize first. Initiating authorization...');
            return authorize();
        } else {
            return Promise.resolve({access_token: sessionStorage.getItem('accessToken')});
        }
    };

        const displayLocalStorageData = () => {
        const localData = localStorage.getItem('retrievedArray');
        if (localData && localData.trim() !== '') {
            document.getElementById('output').innerHTML += '<br>Local storage data: ' + localData;
        }
    };

    ensureAuthorization()
        .then(() => {
            const accessToken = sessionStorage.getItem('accessToken');
            // First, search for a file named "bookmarksMarko.txt"
            return fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27bookmarksMarko.txt%27', {
                method: 'GET',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.files && data.files.length > 0) {
                // File found, use the first matching file
                return data.files[0].id;
            } else {
                // No file found, fall back to stored fileId
                const storedFileId = sessionStorage.getItem('fileId');
                if (!storedFileId) {
                    throw new Error('No file found with name "bookmarksMarko.txt" and no stored file ID.');
                }
                return storedFileId;
            }
        })
        .then(fileId => {
            // Now that we have a fileId (either from search or storage), retrieve the file
            const accessToken = sessionStorage.getItem('accessToken');
            return fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                method: 'GET',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
            });
        })
        .then(response => response.text())
        .then(data => {
            localStorage.clear();
            localStorage.setItem('retrievedArray', data);
            document.getElementById('output').innerText = 'Retrieved from Drive: ' + data;
            displayLocalStorageData();
            document.getElementById('syncFromDrive').disabled = false;
        })
        .catch(error => {
            alert('Error retrieving file: ' + error.message);
            document.getElementById('syncFromDrive').disabled = false;
        });
}

    window.onload = initializeGoogleIdentity;
</script>
</body>
</html>
